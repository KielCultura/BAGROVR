<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BagRovr - Baguio City Travel Guide & Itinerary</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* ...your styles... */
    .history { max-height: 300px; overflow-y: auto; background: #f7faff; padding: 1em; margin-bottom: 1em; border-radius: 10px; }
    .itinerary-details { display: flex; gap: 8px; align-items: center; }
    .itinerary-details input, .itinerary-details textarea { font-size: 0.96em; }
    .export-btn { margin-top: 10px; background: #4169e1; color: #fff; border: none; border-radius: 5px; padding: 9px 22px; cursor: pointer;}
    .export-btn:hover { background: #3146b6; }
  </style>
</head>
<body>
  <div class="container">
    <form id="searchForm" autocomplete="off">
      <input id="searchInput" type="text" placeholder="Search for places..." required />
      <button type="submit">Search</button>
    </form>
    <div class="history" id="history"></div>
    <div class="results-title" id="resultsTitle" style="display:none;">Latest Results</div>
    <div class="results" id="results"></div>
  </div>
  <div class="itinerary" id="itinerary">
    <h4>My Itinerary</h4>
    <ul id="itineraryList"></ul>
    <button class="export-btn" onclick="exportItineraryAsPDF()">Export as PDF</button>
  </div>
  <script>
    let history = []; // Array of { query, places }
    let itinerary = [];

    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/[&<>"'`=\/]/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;',
        '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
      })[s]);
    }

    function renderHistory() {
      const el = document.getElementById('history');
      el.innerHTML = '';
      history.forEach((entry, idx) => {
        const title = document.createElement('div');
        title.innerHTML = `<b>Results for:</b> ${escapeHTML(entry.query)}`;
        el.appendChild(title);
        entry.places.forEach((place, i) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <span class="card-title">${escapeHTML(place.name)}</span>
            <button onclick="addToItineraryFromHistory(${idx},${i})">Add to Itinerary</button>
            <div><b>Address:</b> ${escapeHTML(place.address)}</div>
            <a href="${escapeHTML(place.google_maps_url)}" target="_blank">Google Maps</a>
            ${place.review ? `<div class="card-desc">${escapeHTML(place.review)}</div>` : ''}
            <hr/>
          `;
          el.appendChild(card);
        });
      });
    }

    function renderItinerary() {
      const el = document.getElementById('itineraryList');
      el.innerHTML = '';
      itinerary.forEach((place, idx) => {
        el.innerHTML += `
          <li>
            <div>
              <b>${idx + 1}.</b> <a href="${escapeHTML(place.google_maps_url)}" target="_blank">${escapeHTML(place.name)}</a>
            </div>
            <div class="itinerary-details">
              <label>Time/Notes:</label>
              <input type="text" value="${escapeHTML(place.timeSpent || '')}" 
                onchange="updateItineraryTime(${idx}, this.value)" placeholder="e.g. 2 hours, or 'Lunch'" />
              <textarea rows="1" placeholder="Notes..." onchange="updateItineraryNotes(${idx}, this.value)">${escapeHTML(place.userNotes || '')}</textarea>
              <button onclick="removeFromItinerary(${idx})">âœ•</button>
            </div>
          </li>
        `;
      });
    }

    function addToItineraryFromHistory(histIdx, placeIdx) {
      const place = history[histIdx].places[placeIdx];
      if (place && !itinerary.some(x => x.name === place.name && x.address === place.address)) {
        itinerary.push({...place, timeSpent: '', userNotes: ''});
        renderItinerary();
      }
    }
    function updateItineraryTime(idx, val) {
      if (itinerary[idx]) itinerary[idx].timeSpent = val;
    }
    function updateItineraryNotes(idx, val) {
      if (itinerary[idx]) itinerary[idx].userNotes = val;
    }
    function removeFromItinerary(idx) {
      itinerary.splice(idx, 1);
      renderItinerary();
    }

    async function fetchResults(query) {
      const resultsEl = document.getElementById('results');
      const resultsTitleEl = document.getElementById('resultsTitle');
      resultsTitleEl.style.display = "block";
      resultsEl.innerHTML = '<div>Searching...</div>';
      try {
        const resp = await fetch('/api/google-places-groq', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ term: query })
        });
        if (!resp.ok) throw new Error(`API error (${resp.status})`);
        const data = await resp.json();
        const places = Array.isArray(data.places) ? data.places : [];
        history.unshift({ query, places }); // add to history
        if (history.length > 10) history.length = 10; // keep 10 most recent
        renderHistory();
        // show latest results as well
        resultsEl.innerHTML = '';
        places.forEach((place, idx) => {
          resultsEl.innerHTML += `
            <div class="card">
              <span class="card-title">${escapeHTML(place.name)}</span>
              <button onclick="addToItineraryFromHistory(0,${idx})">Add to Itinerary</button>
              <div><b>Address:</b> ${escapeHTML(place.address)}</div>
              <a href="${escapeHTML(place.google_maps_url)}" target="_blank">Google Maps</a>
              ${place.review ? `<div class="card-desc">${escapeHTML(place.review)}</div>` : ''}
            </div>
          `;
        });
      } catch (err) {
        resultsEl.innerHTML = '<div>Sorry, something went wrong.</div>';
      }
    }

    document.getElementById('searchForm').onsubmit = e => {
      e.preventDefault();
      const query = document.getElementById('searchInput').value.trim();
      if (query) {
        fetchResults(query);
        document.getElementById('searchInput').value = '';
      }
    };

    function exportItineraryAsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("My Baguio Itinerary", 20, 20);
      let y = 30;
      itinerary.forEach((place, idx) => {
        doc.text(`${idx + 1}. ${place.name}`, 20, y);
        y += 7;
        doc.text(`Address: ${place.address}`, 22, y);
        y += 7;
        if (place.google_maps_url) {
          doc.textWithLink("Google Maps", 22, y, { url: place.google_maps_url });
          y += 7;
        }
        if (place.timeSpent) {
          doc.text(`Time/Notes: ${place.timeSpent}`, 22, y);
          y += 7;
        }
        if (place.userNotes) {
          doc.text(`Notes: ${place.userNotes}`, 22, y);
          y += 7;
        }
        y += 5;
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save("bagrovr-itinerary.pdf");
    }

    window.onload = () => {
      renderItinerary();
      renderHistory();
    }
  </script>
</body>
</html>
